# How to interact with tracim API

Tracim is based on a REST api using mostly json format.

Api endpoint and autogenerated documentation is always avalaible when Tracim Backend is running at : `(tracim_backend_url)/api/v2/doc/`

For example, if you run tracim in local with the default config:
`http://localhost:6543/api/v2/doc/`

Here is the list of all endpoints available with most of the informations required to use them.

:warning: You need to be authenticated to use most of these endpoints, result of endpoints may vary depending on user authentication.

## Authentication

There is many auth mecanism in Tracim as you can see in [setting documentation](setting.md).
Each one is best for a specific usage :

- `Basic-Auth` if you want to communicate easily as user to tracim.
- `Api-Key` if you are administrator and you want to create daemon, be careful, api key give full access to tracim :warning:.
- `Cookie` if you work with a frontend (ui/) and don't want to store credentials for security reasons (use `/api/v2/auth/login` to log in).

`/api/v2/auth/whoami` is a the endpoint to know if you are authenticated.

## Authentification

Examples given are done with [httpie](https://httpie.org/) program.

### Basic-Auth

you need to use your username/password like in standard basic auth as in [rfc7616](https://tools.ietf.org/html/rfc7617). So username and password are base64 encoded in `Authorization` header.

```
$ http -a admin@admin.admin:admin@admin.admin GET http://127.0.0.1:6543/api/v2/auth/whoami
HTTP/1.1 200 OK
Content-Length: 276
Content-Type: application/json
Date: Tue, 22 Jan 2019 11:26:53 GMT
Server: waitress
Set-Cookie:  session_key=22fd293b6d850faabc8e3f167bcfc804d8713deed03bc15e5029434687050fb809ef2076; expires=Mon, 22-Jan-2019 11:26:53 GMT; Path=/; SameSite=Lax

{
    "auth_type": "internal", 
    "avatar_url": null, 
    "caldav_url": null, 
    "created": "2019-01-18T13:07:02Z", 
    "email": "admin@admin.admin", 
    "is_active": true, 
    "is_deleted": false, 
    "lang": null, 
    "profile": "administrators", 
    "public_name": "Global manager", 
    "timezone": "", 
    "user_id": 1
}
```

### Api-Key

you need to set 2 custom headers: `Tracim-Api-Key` with a correct api key and `Tracim-Api-Login` with a valid user login.

```
$ http GET http://127.0.0.1:6543/api/v2/auth/whoami Tracim-Api-Key:changethisnow! Tracim-Api-Login:admin@admin.admin
HTTP/1.1 200 OK
Content-Length: 276
Content-Type: application/json
Date: Tue, 22 Jan 2019 13:00:49 GMT
Server: waitress
Set-Cookie:  session_key=50307c9007fff16791f660eed14d47a33cf11eef365b3e0403ce42f5a8b8f1f12c254b58; expires=Mon, 22-Jan-2018 13:00:49 GMT; Path=/; SameSite=Lax

{
    "auth_type": "internal", 
    "avatar_url": null, 
    "caldav_url": null, 
    "created": "2019-01-18T13:07:02Z", 
    "email": "admin@admin.admin", 
    "is_active": true, 
    "is_deleted": false, 
    "lang": null, 
    "profile": "administrators", 
    "public_name": "Global manager", 
    "timezone": "", 
    "user_id": 1
}
```


### Login (to get Auth Cookie)

You need to send a json with `email` and `password` field
```                                                                                                                                                                                                     
$ http POST http://127.0.0.1:6543/api/v2/auth/login email=admin@admin.admin password=admin@admin.admin
HTTP/1.1 200 OK
Content-Length: 276
Content-Type: application/json
Date: Tue, 22 Jan 2019 16:04:37 GMT
Server: waitress
Set-Cookie:  session_key=92504e7310aa6433b523405591a9785e056927dab15e49f7c3204aed88ccc35a70761638; expires=Tue, 29-Jan-2019 16:04:37 GMT; Path=/; SameSite=Lax

{
    "auth_type": "internal", 
    "avatar_url": null, 
    "caldav_url": null, 
    "created": "2019-01-18T13:07:02Z", 
    "email": "admin@admin.admin", 
    "is_active": true, 
    "is_deleted": false, 
    "lang": null, 
    "profile": "administrators", 
    "public_name": "Global manager", 
    "timezone": "", 
    "user_id": 1
}
```

Then you need to resend cookie using `Cookie` header like any browser do automatically to have a temporary access.

```
$ http GET http://127.0.0.1:6543/api/v2/auth/whoami Cookie:" session_key=92504e7310aa6433b523405591a9785e056927dab15e49f7c3204aed88ccc35a70761638"
HTTP/1.1 200 OK
Content-Length: 276
Content-Type: application/json
Date: Tue, 22 Jan 2019 16:05:38 GMT
Server: waitress
Set-Cookie:  session_key=978301c4058de0646a4c6acf55a2b28b102b297f590edf75ffec4295b34435d8bedd3cb7; expires=Tue, 29-Jan-2019 16:05:38 GMT; Path=/; SameSite=Lax

{
    "auth_type": "internal", 
    "avatar_url": null, 
    "caldav_url": null, 
    "created": "2019-01-18T13:07:02Z", 
    "email": "admin@admin.admin", 
    "is_active": true, 
    "is_deleted": false, 
    "lang": null, 
    "profile": "administrators", 
    "public_name": "Global manager", 
    "timezone": "", 
    "user_id": 1
}
```

## Others info about Api

### Error cases

Tracim Api return explicit error when fields given are uncorrect:

```
$ http POST  http://127.0.0.1:6543/api/v2/auth/login
HTTP/1.1 400 Bad Request
Content-Length: 169
Content-Type: application/json
Date: Tue, 22 Jan 2019 12:47:52 GMT
Server: waitress

{
    "code": 2001, 
    "details": {
        "email": [
            "Missing data for required field."
        ], 
        "password": [
            "Missing data for required field."
        ]
    }, 
    "message": "Validation error of input data"
}
```

You can also see an error code in json response as `code`, this is useful in case you want to process error when http status is `400`, there is many error cases, so you need a more explicit error code for all possible cases.
You can see name related to error code in [error.py](../tracim_backend/error.py) file.

:warning: [a specific endpoint about error cases code, will be added later](https://github.com/tracim/tracim/issues/1006).
 
